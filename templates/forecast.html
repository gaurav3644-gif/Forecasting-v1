<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure Forecast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .zoom-wrapper {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
        }
        .lang-toggle {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1060;
            display: inline-flex;
            gap: 6px;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(18,24,39,0.12);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 12px 30px rgba(18,24,39,0.08);
        }
        .top-nav {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1060;
            display: inline-flex;
            gap: 8px;
        }
        .lang-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 0.25rem 0.55rem;
            border: 1px solid rgba(18,24,39,0.12);
            background: #fff;
            color: rgba(18,24,39,0.72);
            font-size: 0.8rem;
            font-weight: 800;
            line-height: 1;
        }
        .lang-btn.active {
            background: rgba(13,110,253,0.08);
            border-color: rgba(13,110,253,0.22);
            color: #0d6efd;
        }
        .lang-flag {
            width: 18px;
            height: 12px;
            border-radius: 3px;
            display: inline-block;
            border: 1px solid rgba(18,24,39,0.18);
            box-shadow: 0 1px 0 rgba(18,24,39,0.06);
            font-size: 0;
            line-height: 0;
        }
        .lang-btn[data-lang="id"] .lang-flag {
            background: linear-gradient(#ce1126 0 50%, #ffffff 50% 100%);
        }
        .lang-btn[data-lang="en"] .lang-flag {
            background:
              linear-gradient(to right, transparent 0 44%, #ce1126 44% 56%, transparent 56% 100%),
              linear-gradient(to bottom, transparent 0 44%, #ce1126 44% 56%, transparent 56% 100%),
              #ffffff;
        }
        body {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: white;
            border: 1px solid #e9ecef;
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
    <script>
      (function() {
        const STORAGE_KEY = 'pitensor_lang';
        const translations = {
          en: { lang_en: 'EN', lang_id: 'ID', forecast_configure: 'Configure Forecast', forecast_grain: 'Forecast Grain', forecast_months: 'Number of Months to Forecast', forecast_run: 'Run Forecast' },
          id: { lang_en: 'EN', lang_id: 'ID', forecast_configure: 'Konfigurasi Peramalan', forecast_grain: 'Tingkat Peramalan', forecast_months: 'Jumlah Bulan untuk Diramalkan', forecast_run: 'Jalankan Peramalan' }
        };
        function getCookie(name) {
          try {
            const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '=([^;]*)'));
            return m ? decodeURIComponent(m[1]) : '';
          } catch (e) { return ''; }
        }
        function setCookie(name, value) {
          try { document.cookie = `${name}=${encodeURIComponent(value)}; Path=/; Max-Age=31536000; SameSite=Lax`; } catch (e) {}
        }
        function storageGet(key) { try { return localStorage.getItem(key) || ''; } catch (e) { return ''; } }
        function storageSet(key, value) { try { localStorage.setItem(key, value); return true; } catch (e) { return false; } }
        function getLang() {
          const saved = (storageGet(STORAGE_KEY) || getCookie(STORAGE_KEY) || (window.__pitensor_lang || '')).toLowerCase();
          return (saved === 'id' || saved === 'en') ? saved : 'en';
        }
        function t(key) {
          const lang = getLang();
          return (translations[lang] && translations[lang][key]) || (translations.en && translations.en[key]) || key;
        }
        function apply() {
          const lang = getLang();
          document.documentElement.setAttribute('lang', lang);
          document.querySelectorAll('.lang-btn[data-lang]').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-lang') === lang));
          document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.getAttribute('data-i18n'); if (k) el.textContent = t(k); });
        }
        function setLang(lang) {
          const next = (lang || '').toLowerCase();
          if (next !== 'en' && next !== 'id') return;
          window.__pitensor_lang = next;
          storageSet(STORAGE_KEY, next);
          setCookie(STORAGE_KEY, next);
          apply();
        }
        document.addEventListener('pointerdown', function(e) {
          const btn = e.target.closest('.lang-btn[data-lang]');
          if (!btn) return;
          setLang(btn.getAttribute('data-lang'));
        });
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', apply);
        } else {
          apply();
        }
        window.addEventListener('pageshow', apply);
      })();
    </script>
</head>
<body>
    <div class="zoom-wrapper">
        <div class="top-nav">
            <a href="/dashboard" class="btn btn-outline-secondary btn-sm">Dashboard</a>
            <a href="/" class="btn btn-outline-secondary btn-sm">Landing</a>
        </div>
        <div class="lang-toggle" aria-label="Language toggle">
            <button type="button" class="lang-btn" data-lang="en" title="EN">
                <span class="lang-flag" aria-hidden="true">üá¨üáß</span><span data-i18n="lang_en">EN</span>
            </button>
            <button type="button" class="lang-btn" data-lang="id" title="ID">
                <span class="lang-flag" aria-hidden="true">üáÆüá©</span><span data-i18n="lang_id">ID</span>
            </button>
        </div>
        <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center">
        <div class="row justify-content-center w-100">
            <div class="col-12 d-flex justify-content-center">
                <div class="card p-5" style="max-width: 980px; width: 100%; margin: 2rem auto;">
                    <div class="text-center mb-4">
                        <i class="fas fa-cogs fa-3x text-success mb-3"></i>
                        <h1 class="h3 mb-3 font-weight-normal"><span aria-hidden="true">‚öôÔ∏è</span> <span data-i18n="forecast_configure">Configure Forecast</span></h1>
                        <p class="text-muted">Set your forecast parameters</p>
                    </div>
                    <form action="/forecast" method="post" id="forecastForm" autocomplete="off">
                        <input type="hidden" name="run_session_id" value="{{ run_session_id }}">
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="fas fa-layer-group"></i> <span data-i18n="forecast_grain">Forecast Grain</span></label>
                                                    <div class="form-text mb-2">Select one or more columns to define the level of forecasting (e.g. Country, Store, Item)</div>
                                                    <div class="row">
                                                        {% for col in columns %}
                                                        <div class="col-6 col-md-4 mb-1">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" name="grain" value="{{ col }}" id="grain-{{ loop.index }}" {% if col in ['item','store'] %}checked{% endif %}>
                                                                <label class="form-check-label" for="grain-{{ loop.index }}">{{ col }}</label>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="mb-3 border rounded-3 p-3 bg-light">
                                                    <label class="form-label"><i class="fas fa-sliders-h"></i> Additional Features for Training</label>
                                                    <div class="form-text mb-2">Select columns from your data to use as features in the model (e.g. category, region, price)</div>
                                                    <div class="row">
                                                        {% for col in columns %}
                                                        {% if col not in ['date', 'sales'] %}
                                                        <div class="col-6 col-md-4 mb-1">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" name="extra_features" value="{{ col }}" id="feature-{{ loop.index }}">
                                                                <label class="form-check-label" for="feature-{{ loop.index }}">{{ col }}</label>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-calendar-check"></i> Last Data Month</label>
                                <input type="text" class="form-control" value="{{ last_month }}" readonly>
                                <div class="form-text">The last month in your uploaded data</div>
                            </div>
                            <div class="col-md-4">
                                <label for="start_month" class="form-label"><i class="fas fa-calendar-alt"></i> Forecast Start Month</label>
                                <input type="month" class="form-control" id="start_month" name="start_month" value="{{ default_start_month }}" required>
                                <div class="form-text">Choose the month from which to start forecasting (default: 3 months before last data month)</div>
                            </div>
                            <div class="col-md-4">
                                <label for="months" class="form-label"><i class="fas fa-clock"></i> <span data-i18n="forecast_months">Number of Months to Forecast</span></label>
                                <input type="number" class="form-control" id="months" name="months" value="7" min="1" max="24" step="1" required>
                                <div class="form-text">How many months ahead to forecast</div>
                            </div>
                        </div>

                        <!-- Out-of-Stock Imputation -->
                        <div class="mb-3 border rounded-3 p-3" style="background-color: #f8f9fa;">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enable_oos_imputation" name="enable_oos_imputation">
                                <label class="form-check-label" for="enable_oos_imputation">
                                    <strong><i class="fas fa-box-open"></i> Enable Out-of-Stock Imputation</strong>
                                    <div class="small text-muted">Impute sales for days when products were out of stock</div>
                                </label>
                            </div>
                            <div id="oos_column_selector" style="display:none;">
                                <label for="oos_column" class="form-label">Out-of-Stock Column</label>
                                <select class="form-select" id="oos_column" name="oos_column">
                                    <option value="">-- Select OOS column --</option>
                                    {% for col in numeric_columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select the column that indicates out-of-stock days (1 = out of stock, 0 = in stock)</div>
                            </div>
                        </div>

                        <div class="d-grid">
                                <div class="d-flex gap-2">
                                <button id="runForecastBtn" type="submit" class="btn btn-success btn-lg flex-grow-1">
                                    <i class="fas fa-rocket me-2"></i><span aria-hidden="true">üöÄ</span> <span data-i18n="forecast_run">Run Forecast</span>
                                </button>
                                <button id="stopForecastBtn" type="button" class="btn btn-outline-danger btn-lg" disabled>
                                    <i class="fas fa-stop me-2"></i>Stop
                                </button>
                                </div>
                                <div id="progressContainer" style="display:none; margin-top:2rem;">
                                    <div class="progress" style="height: 2rem;">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; font-size: 1.1rem;">0%</div>
                                    </div>
                                    <div id="progressStatus" style="margin-top:0.7rem; text-align:center; color:#333; font-size:1.1rem;"></div>
                                </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('forecastForm');
        const runBtn = document.getElementById('runForecastBtn');
        const stopBtn = document.getElementById('stopForecastBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressStatus = document.getElementById('progressStatus');
        const runSessionId = (document.querySelector('input[name=\"run_session_id\"]') || {}).value || '';

        // OOS imputation toggle
        const oosCheckbox = document.getElementById('enable_oos_imputation');
        const oosColumnSelector = document.getElementById('oos_column_selector');
        if (oosCheckbox && oosColumnSelector) {
            oosCheckbox.addEventListener('change', function() {
                oosColumnSelector.style.display = this.checked ? 'block' : 'none';
            });
        }

        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                runBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressStatus.textContent = 'Starting forecast...';

                // Gather form data
                const formData = new FormData(form);

                // Start forecast via AJAX
                fetch('/forecast', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json()
                            .then((data) => {
                                const msg = (data && data.error) ? String(data.error) : 'Could not start forecast.';
                                progressStatus.textContent = msg;
                                runBtn.disabled = false;
                                if (stopBtn) stopBtn.disabled = true;
                            })
                            .catch(() => {
                                progressStatus.textContent = 'Could not start forecast.';
                                runBtn.disabled = false;
                                if (stopBtn) stopBtn.disabled = true;
                            });
                    }
                    pollProgress();
                })
                .catch(err => {
                    progressStatus.textContent = 'Error starting forecast.';
                    runBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                });
            });
        }

        if (stopBtn) {
            stopBtn.addEventListener('click', function() {
                stopBtn.disabled = true;
                progressStatus.textContent = 'Cancelling...';
                const qs = runSessionId ? ('?run_session_id=' + encodeURIComponent(runSessionId)) : '';
                fetch('/forecast_stop' + qs, { method: 'POST' }).catch(() => { /* ignore */ });
            });
        }

        function pollProgress() {
            const qs = runSessionId ? ('?run_session_id=' + encodeURIComponent(runSessionId)) : '';
            fetch('/forecast_status' + qs)
                .then(res => res.json())
                .then(data => {
                    let pct = Math.round((data.progress || 0) * 100);
                    progressBar.style.width = pct + '%';
                    progressBar.textContent = pct + '%';
                    progressStatus.textContent = data.status || '';
                    if (data.cancelled) {
                        runBtn.disabled = false;
                        if (stopBtn) stopBtn.disabled = true;
                        return;
                    }
                    if (data.done) {
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressStatus.textContent = 'Forecast complete! Redirecting...';
                        const dest = runSessionId ? ('/results?run_session_id=' + encodeURIComponent(runSessionId)) : '/results';
                        setTimeout(() => { window.location.href = dest; }, 800);
                    } else if (data.error) {
                        progressStatus.textContent = 'Error: ' + data.error;
                        runBtn.disabled = false;
                        if (stopBtn) stopBtn.disabled = true;
                    } else {
                        setTimeout(pollProgress, 800);
                    }
                })
                .catch(() => {
                    progressStatus.textContent = 'Error checking progress.';
                    runBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                });
        }

        // If a forecast is already running (e.g., user navigated away to Dashboard and came back),
        // pick up the existing progress instead of showing the Run button state.
        fetch('/forecast_status' + (runSessionId ? ('?run_session_id=' + encodeURIComponent(runSessionId)) : ''))
            .then(res => res.json())
            .then(data => {
                const statusText = String((data && data.status) || '');
                const hasStarted = statusText && statusText !== 'Not started';
                const isRunning = hasStarted && !data.done && !data.cancelled && !data.error;
                if (isRunning) {
                    runBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = false;
                    progressContainer.style.display = 'block';
                    pollProgress();
                }
            })
            .catch(() => { /* ignore */ });
    });
    </script>
    </div>
</body>
</html>
